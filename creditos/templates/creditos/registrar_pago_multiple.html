{% extends "layout_creditos.html" %}
{% load humanize %}
{% block title %} Registrar Pagos | CrÃ©dito #{{ credito.id }} {% endblock %}

{% block content %}

<style>
    .card-financiera {
        border-radius: 14px !important;
        border: none;
        background: white;
        padding: 25px;
        box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }

    .tabla-financiera thead {
        background: #2ecc71 !important;
        color: white;
        font-weight: 600;
        text-align: center;
    }

    .tabla-financiera tbody tr td {
        vertical-align: middle;
    }

    .btn-add {
        border-radius: 8px;
        font-size: 15px;
        padding: 6px 14px;
    }

    .btn-pago {
        background: #0d6efd;
        color: white;
        border-radius: 6px;
        font-weight: 600;
    }

    .btn-abono {
        background: #198754;
        color: white;
        border-radius: 6px;
        font-weight: 600;
    }

    .btn-eliminar {
        border-radius: 6px;
    }

    .total-box {
        font-size: 1.3rem;
        font-weight: 700;
        color: #198754;
    }
</style>


<div class="container mt-4">

    <div class="card card-financiera">

        <!-- Encabezado -->
        <h3 class="fw-bold text-success mb-3">
            ðŸ’µ Registrar Pagos â€” CrÃ©dito #{{ credito.id }}
        </h3>

        <p class="fs-5"><strong>Saldo actual:</strong> ${{ saldo|floatformat:0|intcomma }}</p>

        <form method="post" id="pagoForm">
            {% csrf_token %}
            {{ formset.management_form }}

            <div class="table-responsive">
                <table class="table tabla-financiera table-bordered" id="pagosTable">
                    <thead>
                        <tr>
                            <th>Cuota</th>
                            <th>Valor a pagar</th>
                            <th>InterÃ©s mora</th>
                            <th>Cobro jurÃ­dico</th>
                            <th>Total</th>
                            <th>ObservaciÃ³n</th>
                            <th>AcciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                        <tr class="pago-row">

                            <td>{{ form.cuota_numero }}</td>

                            <td>{{ form.valor_pagado }}</td>

                            <td>
                                <input type="number" step="0.01" class="form-control mora-input"
                                       name="form-{{ forloop.counter0 }}-interes_moratorio_pagado" value="0">
                            </td>

                            <td>
                                <input type="number" step="0.01" class="form-control juridico-input"
                                       name="form-{{ forloop.counter0 }}-cobro_juridico_pagado" value="0">
                            </td>

                            <td class="fw-bold total-linea">$0.00</td>

                            <td>{{ form.observacion }}</td>

                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm eliminar-fila btn-eliminar">
                                    âœ•
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- BotÃ³n agregar -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <button type="button" class="btn btn-outline-success btn-add" id="agregarFila">
                    âž• Agregar Cuota
                </button>

                <div class="total-box">
                    Total a pagar: <span id="totalPagar">$0.00</span>
                </div>
            </div>

            <hr>

            <!-- Botones de acciÃ³n principal -->
            <div class="d-flex justify-content-between">

                <div class="d-flex gap-2">
                    <button type="submit" name="accion" value="pago" class="btn btn-pago">
                        ðŸ’µ Registrar Pagos
                    </button>
                    <button type="submit" name="accion" value="abono" class="btn btn-abono">
                        ðŸŸ© Abono a Capital
                    </button>
                </div>

                <div class="total-box">
                    Total: <span id="totalPagar">$0.00</span>
                </div>

            </div>

            <hr>

            <!-- Botones finales -->
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">Guardar Pagos</button>
                <a href="{% url 'detalle_credito' credito.id %}" class="btn btn-secondary">Volver</a>
            </div>

        </form>

    </div>

</div>


<!-- ===================== -->
<!--  JAVASCRIPT ACTUALIZADO -->
<!-- ===================== -->
<script>
document.addEventListener("DOMContentLoaded", () => {

  const tableBody = document.querySelector("#pagosTable tbody");
  const agregarFilaBtn = document.getElementById("agregarFila");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");
  const totalPagarEls = document.querySelectorAll("#totalPagar");
  const pagoForm = document.getElementById("pagoForm");

  function calcularFila(fila) {
      const cuota = parseFloat(fila.querySelector("input[name$='valor_pagado']").value) || 0;
      const mora = parseFloat(fila.querySelector(".mora-input").value) || 0;
      const juridico = parseFloat(fila.querySelector(".juridico-input").value) || 0;

      const total = cuota + mora + juridico;

      fila.querySelector(".total-linea").textContent =
          "$" + total.toLocaleString("es-CO", { minimumFractionDigits: 2 });

      return total;
  }

  function actualizarTotal() {
      let total = 0;
      document.querySelectorAll(".pago-row").forEach(fila => {
          total += calcularFila(fila);
      });

      const txt = "$" + total.toLocaleString("es-CO", { minimumFractionDigits: 2 });
      totalPagarEls.forEach(el => el.textContent = txt);
  }

  // Cargar valores de la cuota, mora y jurÃ­dico
  tableBody.addEventListener("change", async (e) => {
      if (e.target.name.includes("cuota_numero")) {
          const fila = e.target.closest("tr");
          const cuota = e.target.value;

          if (!cuota) return;

          try {
              const res = await fetch(`/creditos/{{ credito.id }}/info_cuota/?cuota=${cuota}`);
              const data = await res.json();

              fila.querySelector("input[name$='valor_pagado']").value = data.valor_cuota;
              fila.querySelector(".mora-input").value = data.mora;
              fila.querySelector(".juridico-input").value = data.juridico;

              actualizarTotal();
          } catch (err) { console.error(err); }
      }
  });

  document.addEventListener("input", (e) => {
      if (e.target.classList.contains("mora-input") ||
          e.target.classList.contains("juridico-input") ||
          e.target.name.endsWith("valor_pagado")) {
          actualizarTotal();
      }
  });

  // ==========================
  // AGREGAR FILA
  // ==========================
  agregarFilaBtn.addEventListener("click", () => {
      const formIndex = parseInt(totalForms.value);
      const plantilla = document.querySelector(".pago-row");
      const nuevaFila = plantilla.cloneNode(true);

      nuevaFila.querySelectorAll("input, select, textarea").forEach(el => {
          if (el.name) {
              const name = el.name.replace(/-\d+-/, `-${formIndex}-`);
              el.name = name;
              el.id = "id_" + name;
          }
          el.value = "";
      });

      tableBody.appendChild(nuevaFila);
      totalForms.value = formIndex + 1;
      actualizarTotal();
  });

  // ==========================
  // ELIMINAR FILA
  // ==========================
  tableBody.addEventListener("click", (e) => {
      if (e.target.classList.contains("eliminar-fila")) {
          const fila = e.target.closest("tr");
          if (document.querySelectorAll(".pago-row").length > 1) {
              fila.remove();

              const filas = document.querySelectorAll(".pago-row");
              filas.forEach((f, idx) => {
                  f.querySelectorAll("input, select, textarea").forEach(el => {
                      if (!el.name) return;
                      const newName = el.name.replace(/-\d+-/, `-${idx}-`);
                      el.name = newName;
                      el.id = "id_" + newName;
                  });
              });

              totalForms.value = filas.length;
              actualizarTotal();
          }
      }
  });

  actualizarTotal();

  // ==========================
  // SUBMIT AJAX
  // ==========================
  pagoForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const btn = document.activeElement;
    let accion = null;
    if (btn && btn.name === 'accion') accion = btn.value;

    const formData = new FormData(pagoForm);
    formData.append('ajax', '1');
    if (accion) formData.set('accion', accion);

    try {
      const res = await fetch(pagoForm.action || window.location.href, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });

      if (res.headers.get('content-type')?.includes('application/json')) {
        const data = await res.json();
        if (data.ok && data.recibo_url) {
          window.open(data.recibo_url, '_blank');
          if (data.redirect_url) {
            window.location.href = data.redirect_url;
          } else window.location.reload();
          return;
        } else {
          alert("Error generando recibo.");
        }
      } else {
        window.location.reload();
      }
    } catch (err) {
      console.error(err);
      alert("OcurriÃ³ un error al enviar los pagos.");
    }
  });

});
</script>

{% endblock %}
