{% extends "layout_creditos.html" %}
{% load humanize %}

{% block title %} Detalle del CrÃ©dito #{{ credito.id }} {% endblock %}

{% block content %}

<style>
    .titulo-financiera {
        font-weight: 700;
        color: #2c3e50;
    }

    .card-financiera {
        border-radius: 12px !important;
        border: none;
        background: white;
        box-shadow: 0 4px 14px rgba(0,0,0,0.1);
    }

    .card-header-financiera {
        background: #0d6efd;
        color: white;
        border-radius: 12px 12px 0 0 !important;
    }

    .table-financiera th {
        background: #f1f3f5;
        font-weight: 600;
    }

    .table-financiera td {
        vertical-align: middle;
    }
</style>

<div class="container">

    <div class="card card-financiera mt-4">

        <!-- HEADER -->
        <div class="card-header card-header-financiera">
            <h4 class="mb-0">ðŸ“„ Detalle del CrÃ©dito #{{ credito.id }}</h4>
        </div>

        <!-- BODY -->
        <div class="card-body">

            <h5 class="titulo-financiera mb-3">InformaciÃ³n del CrÃ©dito</h5>

            <p><strong>Cliente:</strong> {{ credito.usuario }}</p>
            <p><strong>VehÃ­culo (prenda):</strong> {{ credito.vehiculo }}</p>
            <p><strong>Valor del crÃ©dito:</strong> ${{ credito.valor_inicial|floatformat:0|intcomma }}</p>
            <p><strong>InterÃ©s mensual:</strong> {{ credito.interes }}%</p>

            <hr>

            <!-- ESTADO FINANCIERO -->
            <h5 class="titulo-financiera">Estado Financiero Actual</h5>

            <p><strong>Saldo de capital:</strong> ${{ saldo_capital|floatformat:0|intcomma }}</p>
            <p><strong>Intereses pendientes:</strong> ${{ intereses_pendientes|floatformat:0|intcomma }}</p>

            <p class="mt-2">
                <strong class="text-success">Saldo total (capital + intereses):</strong>
                <span class="fw-bold text-success">${{ saldo|floatformat:0|intcomma }}</span>
            </p>

            <p>
                <strong>Estado:</strong>
                <span class="badge 
                    {% if credito.estado == 'Activo' %} bg-success
                    {% elif credito.estado == 'En mora' %} bg-warning text-dark
                    {% elif credito.estado == 'Cobro jurÃ­dico' %} bg-danger
                    {% else %} bg-secondary {% endif %}
                ">
                    {{ credito.estado }}
                </span>
            </p>
            <p><strong>Servicios Activos:</strong> ${{ credito.total_servicios_activos|floatformat:0|intcomma }}</p>

                <ul>
                {% for servicio in servicios_activos %}
                    <li>{{ servicio.get_tipo_display }}: ${{ servicio.valor_anual|floatformat:0|intcomma }} ({{ servicio.fecha_inicio }} a {{ servicio.fecha_fin }})</li>
                {% endfor %}
                </ul>

            {% if credito.pagos.last and credito.pagos.last.tipo_pago == 'abono' %}
            <div class="alert alert-info">
                ðŸ”„ Se realizÃ³ un <strong>abono a capital</strong> recientemente.  
                Las cuotas fueron recalculadas segÃºn el nuevo saldo.
            </div>
            {% endif %}

            <a href="{% url 'generar_excel_cronograma' credito.id %}" class="btn btn-success">
                ðŸ“Š Descargar Excel Cuotas
            </a>

            <hr>

            <!-- CRONOGRAMA DE PAGOS -->
            <h5 class="titulo-financiera mb-3">ðŸ“… Cronograma de Pagos</h5>

            <div class="table-responsive">
                <table class="table table-striped table-bordered table-financiera mt-3">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha de vencimiento</th>
                            <th>Abono a capital</th>
                            <th>InterÃ©s</th>
                            <th>Valor cuota</th>
                            <th>Saldo restante</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in cronograma %}
                        <tr>
                            <td>{{ c.numero }}</td>
                            <td>{{ c.fecha_vencimiento }}</td>
                            <td>${{ c.abono_capital|floatformat:0|intcomma }}</td>
                            <td>${{ c.interes|floatformat:0|intcomma }}</td>
                            <td>${{ c.cuota_total|floatformat:0|intcomma }}</td>
                            <td>${{ c.saldo_restante|floatformat:0|intcomma }}</td>
                            <td>
                                {% if c.pagada %}
                                    <span class="badge bg-success">Pagada</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Pendiente</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <hr>

            <!-- PAGOS REGISTRADOS -->
            <h5 class="titulo-financiera mb-3">ðŸ’µ Pagos Registrados</h5>

            <div class="table-responsive">
                <table class="table table-striped table-bordered table-financiera">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cuota</th>
                            <th>Valor</th>
                            <th>ObservaciÃ³n</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in pagos %}
                        <tr>
                            <td>{{ p.fecha_pago }}</td>
                            <td>{{ p.cuota_numero }}</td>
                            <td>${{ p.valor_pagado|floatformat:0|intcomma }}</td>
                            <td>{{ p.observacion }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                Sin pagos registrados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4">
                <a href="{% url 'registrar_pago' credito.id %}" class="btn btn-success">
                    ðŸ’° Registrar Pago
                </a>

                <a href="{% url 'crear_credito' %}" class="btn btn-secondary">
                    âž• Nuevo CrÃ©dito
                </a>
            </div>

        </div>
    </div>

</div>

{% endblock %}
