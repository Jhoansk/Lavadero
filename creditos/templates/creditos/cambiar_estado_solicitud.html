{% extends "layout_creditos.html" %}
{% load humanize %}

{% block title %}Cambiar Estado Solicitud{% endblock %}

{% block content %}

<div class="container">

    <div class="card shadow-sm mb-4" style="max-width: 600px; margin: 0 auto;">
        <div class="card-header bg-warning text-dark text-center">
            <h4 class="mb-0">Cambiar Estado de la Solicitud</h4>
        </div>

        <div class="card-body">

            <!-- INFO SOLICITUD -->
            <p class="mb-3">
                <strong>Solicitud #{{ solicitud.id }}</strong><br>
                <span>
                    Cliente: {{ solicitud.usuario.nombre_u }} {{ solicitud.usuario.apellido_u }}
                </span><br>
                <span>Veh√≠culo: {{ solicitud.vehiculo.placa }}</span><br>
                <span>Valor solicitado: ${{ solicitud.valor|intcomma }}</span>

                {% if solicitud.estado == "Aprobado" %}
                    <br>
                    <span class="text-success">
                        Valor aprobado: ${{ solicitud.valor_aprobado|intcomma }}
                    </span><br>
                    <span class="text-success">
                        Fecha aprobaci√≥n: {{ solicitud.fecha_aprobacion }}
                    </span>
                {% endif %}
            </p>

            <!-- FORM -->
            <form method="post">
                {% csrf_token %}

                <!-- ESTADO -->
                <div class="mb-3">
                    <label class="form-label">Seleccione el nuevo estado:</label>
                    <select name="estado" id="estado" class="form-select" required>
                        <option value="Estudio" {% if solicitud.estado == "Estudio" %}selected{% endif %}>
                            En Estudio
                        </option>
                        <option value="Aprobado" {% if solicitud.estado == "Aprobado" %}selected{% endif %}>
                            Aprobado
                        </option>
                        <option value="Rechazado" {% if solicitud.estado == "Rechazado" %}selected{% endif %}>
                            Rechazado
                        </option>
                    </select>
                </div>

                <!-- üí∞ VALOR APROBADO -->
                <div id="valor-aprobado-container"
                     class="mb-3"
                     {% if solicitud.estado != "Aprobado" %}style="display:none"{% endif %}>
                    <label class="form-label">Valor aprobado</label>
                    <input type="number"
                           step="0.01"
                           name="valor_aprobado"
                           class="form-control"
                           value="{{ solicitud.valor_aprobado|default:solicitud.valor }}">
                </div>

                <!-- üìÖ FECHA APROBACI√ìN -->
                <div id="fecha-aprobacion-container"
                     class="mb-3"
                     {% if solicitud.estado != "Aprobado" %}style="display:none"{% endif %}>
                    <label class="form-label">Fecha de aprobaci√≥n</label>
                    <input type="date"
                           name="fecha_aprobacion"
                           class="form-control"
                           value="{{ solicitud.fecha_aprobacion|date:'Y-m-d' }}">
                </div>

                <!-- üî• PRENDA -->
                <div id="prenda-container"
                     class="mb-3"
                     {% if solicitud.estado != "Aprobado" %}style="display:none"{% endif %}>
                    <label class="form-label">Persona de la Prenda</label>
                    <select name="prenda" class="form-select">
                        <option value="">Seleccione una persona</option>
                        {% for prenda in prendas %}
                            <option value="{{ prenda.id }}"
                                {% if solicitud.prenda and solicitud.prenda.id == prenda.id %}
                                    selected
                                {% endif %}
                            >
                                {{ prenda.nombres }} {{ prenda.apellidos }} - {{ prenda.documento }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- BOT√ìN -->
                <button type="submit" class="btn btn-primary w-100">
                    Guardar Cambios
                </button>
            </form>

            <!-- VOLVER -->
            <div class="text-center mt-3">
                <a href="{% url 'solicitudes_credito' %}" class="btn btn-secondary btn-sm">
                    Volver al listado
                </a>
            </div>

        </div>
    </div>

</div>

<!-- üéØ JS: mostrar/ocultar campos -->
<script>
    const estadoSelect = document.getElementById("estado");
    const prendaContainer = document.getElementById("prenda-container");
    const valorAprobadoContainer = document.getElementById("valor-aprobado-container");
    const fechaAprobacionContainer = document.getElementById("fecha-aprobacion-container");

    function toggleCampos() {
        if (estadoSelect.value === "Aprobado") {
            prendaContainer.style.display = "block";
            valorAprobadoContainer.style.display = "block";
            fechaAprobacionContainer.style.display = "block";
        } else {
            prendaContainer.style.display = "none";
            valorAprobadoContainer.style.display = "none";
            fechaAprobacionContainer.style.display = "none";
        }
    }

    estadoSelect.addEventListener("change", toggleCampos);
</script>

{% endblock %}
