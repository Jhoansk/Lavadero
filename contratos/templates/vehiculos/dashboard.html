{% extends "vehiculos/layout_contratos.html" %}
{% load humanize %}

{% block content %}

<div class="container-fluid py-3">

    <!-- T√≠tulo -->
    <h2 class="fw-bold mb-4">üìä Dashboard de Gesti√≥n Vehicular</h2>

    <!-- TARJETAS -->
    <div class="row g-3">

        <div class="col-md-3">
            <div class="card p-3 text-center">
                <h5>Total Veh√≠culos</h5>
                <h3 class="text-primary fw-bold">{{ total_vehiculos }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 text-center">
                <h5>Total Facturas</h5>
                <h3 class="text-danger fw-bold">${{ total_facturas|intcomma }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 text-center">
                <h5>Total Presupuestos</h5>
                <h3 class="text-success fw-bold">${{ total_presupuestos|intcomma }}</h3>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card p-3 text-center">
                <h5>Margen Global</h5>
                <h3 class="fw-bold">{{ porcentaje_ganancia|floatformat:2 }}%</h3>
            </div>
        </div>

    </div>

    <!-- GRAFICOS -->
    <div class="row mt-4 g-3">

        <div class="col-md-8">
            <div class="card p-3">
                <h5 class="title-section">üìà Gastos por Mes</h5>
                <canvas id="gastosMesChart"></canvas>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-3">
                <h5 class="title-section">üöó Estados de Veh√≠culos</h5>
                <canvas id="estadosChart"></canvas>
            </div>
        </div>

    </div>

    <!-- TOP GASTOS -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card p-3">
                <h5 class="title-section">üèÜ Top 5 Veh√≠culos con Mayor Gasto</h5>

                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Gasto Total</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in top_gastos %}
                        <tr>
                            <td>{{ item.id_placa__placa }}</td>
                            <td>${{ item.total|intcomma }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="2" class="text-center text-muted">Sin informaci√≥n</td></tr>
                    {% endfor %}
                    </tbody>
                </table>

            </div>
        </div>
    </div>

    <!-- DOCUMENTOS POR VENCER -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card p-3">
                <h5 class="title-section text-danger">‚ö†Ô∏è Documentos Pr√≥ximos a Vencer</h5>

                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>TO Vencimiento</th>
                            <th>SOAT</th>
                            <th>Tecno</th>
                            <th>RC</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for doc in documentos_vencer %}
                        <tr>
                            <td>{{ doc.id_placa.placa }}</td>
                            <td>{{ doc.fecha_vencimiento_to }}</td>
                            <td>{{ doc.fecha_vencimiento_soat }}</td>
                            <td>{{ doc.fecha_vencimiento_tecno }}</td>
                            <td>{{ doc.fecha_vencimiento_sRc }}</td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="5" class="text-center text-muted">Sin registros.</td></tr>
                    {% endfor %}
                    </tbody>
                </table>

            </div>
        </div>
    </div>

    <!-- √öLTIMOS REGISTROS -->
    <div class="row mt-4 g-3">

        <div class="col-md-6">
            <div class="card p-3">
                <h5 class="title-section">üöò √öltimos Veh√≠culos Registrados</h5>

                <ul class="list-group">
                {% for v in ultimos_vehiculos %}
                    <li class="list-group-item">
                        {{ v.placa }} ‚Äî {{ v.marca }} {{ v.linea }}
                    </li>
                {% empty %}
                    <li class="list-group-item text-center text-muted">Sin registros.</li>
                {% endfor %}
                </ul>

            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-3">
                <h5 class="title-section">üßæ √öltimas Facturas Registradas</h5>

                <ul class="list-group">
                {% for f in ultimas_facturas %}
                    <li class="list-group-item">
                        Factura {{ f.n_factura }} ‚Äî ${{ f.total|intcomma }}
                    </li>
                {% empty %}
                    <li class="list-group-item text-center text-muted">Sin registros.</li>
                {% endfor %}
                </ul>

            </div>
        </div>

    </div>

</div>

{% endblock %}


{% block extra_js %}

<script>
    // DATA INYECTADA DESDE DJANGO (SEGURA)
    const meses = {{ meses_json|safe }};
    const valores = {{ valores_json|safe }};

    const estadosLabels = {{ estados_labels_json|safe }};
    const estadosCantidad = {{ estados_values_json|safe }};

    // ------ GASTOS POR MES ------
    const ctx1 = document.getElementById('gastosMesChart');

    new Chart(ctx1, {
        type: 'line',
        data: {
            labels: meses,
            datasets: [{
                label: 'Gastos ($)',
                data: valores,
                borderWidth: 2,
                tension: 0.3,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(0, 97, 255, 0.2)',
                fill: true
            }]
        }
    });

    // ------ ESTADOS ------
    const ctx2 = document.getElementById('estadosChart');

    new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: estadosLabels,
            datasets: [{
                data: estadosCantidad,
                backgroundColor: [
                    '#0d6efd', '#ffc107', '#28a745', '#dc3545', '#6f42c1'
                ]
            }]
        }
    });
</script>

{% endblock %}
